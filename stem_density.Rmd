---
title: "\\textbf{Stem density}"
author: "\\textbf{Tim White}"
date: ""
output: pdf_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "pdfs") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      fig.height=3, fig.width=5, fig.align='center')
```



# Packages and data

```{r warning=FALSE, message=FALSE}
library(car)
library(tidyverse)
library(lme4)
library(patchwork)
```

```{r}
data_stems <- read_csv("data/data_stems.csv") %>%
                mutate(plot_id = as.factor(plot_id),
                       size_class = as.factor(size_class),
                       harvested = as.factor(harvested),
                       vegetation_type = as.factor(vegetation_type),
                       milpa = as.factor(milpa))
data_plots <- read_csv("data/data_plots.csv") %>%
                mutate(plot_id = as.factor(plot_id),
                       harvested = as.factor(harvested),
                       vegetation_type = as.factor(vegetation_type),
                       milpa = as.factor(milpa))

plot_theme <- theme(plot.background = element_rect(fill = "white"),
                    plot.title = element_blank(), 
                    plot.subtitle = element_text(family="sans", face="plain"), 
                    axis.title.x = element_text(family="sans", face="bold"),
                    axis.title.y = element_text(family="sans", face="bold"),
                    axis.text.x = element_text(family="sans", face="plain"),
                    axis.text.y = element_text(family="sans", face="plain"),
                    panel.background = element_rect(fill="white"),
                    panel.grid.major.x = element_blank(),
                    panel.grid.major.y = element_line(color="gainsboro"),
                    panel.grid.minor = element_blank(),
                    axis.ticks = element_blank(),
                    legend.background = element_rect(color="black", fill = "white"),
                    legend.position = c(0.9, 0.85),
                    legend.title = element_text(color = "black", face = "bold", hjust = 0.5),
                    legend.text = element_text(color = "black"))
```



# Figures

## Histograms of total trees per hectare

```{r}
# All plots
data_plots %>%
  ggplot() +
  geom_histogram(aes(x = stemden_totaltrees), bins = 10, fill = "gray90", col = "black") +
  theme_classic() + ylim(c(0,20)) + labs(x = "Total trees per hectare", y = "Frequency")

# Harvested vs. unharvested plots
data_plots %>%
  ggplot() +
  geom_histogram(aes(x = stemden_totaltrees), bins = 10, fill = "gray90", col = "black") +
  facet_wrap(~harvested) +
  theme_classic() + ylim(c(0,20)) + labs(x = "Total trees per hectare", y = "Frequency")
```

## Five-number summaries of total trees per hectare

```{r}
# All plots
summary(data_plots$stemden_totaltrees)

# Harvested vs. unharvested plots
data_plots %>% filter(harvested == "yes") %>% pull(stemden_totaltrees) %>% summary()
data_plots %>% filter(harvested == "no") %>% pull(stemden_totaltrees) %>% summary()
```

## Box plots of total trees per hectare (log scale)

```{r}
# By harvesting status
stemden_fig1 <- data_plots %>%
  mutate(harvested = fct_recode(harvested,
                                "Harvested" = "yes", "Unharvested" = "no")) %>%
  ggplot() +
  geom_boxplot(aes(x = fct_relevel(harvested, "Harvested", "Unharvested"),
                   y = log(stemden_totaltrees)),
               fill = "mistyrose2", outlier.shape = 21,
               outlier.color = "gray20", outlier.fill = "gray80") +
  plot_theme +
  coord_cartesian(ylim = c(5, 8)) +
  labs(x = "Plot status", y = "Total trees per hectare (log scale)")
ggsave("figures/stemden_fig1.png", height = 4, width = 6)
stemden_fig1

# By vegetation type
stemden_fig2 <- data_plots %>%
  mutate(vegetation_type = fct_recode(vegetation_type,
                                      "Ju'uche'" = "juuche",
                                      "Keelenche'" = "keelenche",
                                      "Nuku'uch che'" = "nukuuchche")) %>%
  ggplot() +
  geom_boxplot(aes(x = vegetation_type, y = log(stemden_totaltrees)),
               fill = "mistyrose2", outlier.shape = 21,
               outlier.color = "gray20", outlier.fill = "gray80") +
  plot_theme +
  coord_cartesian(ylim = c(5, 8)) +
  labs(x = "Vegetation type", y = "Total trees per hectare (log scale)")
ggsave("figures/stemden_fig2.png", height = 4, width = 6)
stemden_fig2

# By milpa exposure
stemden_fig3 <- data_plots %>%
  mutate(milpa = fct_recode(milpa,
                            "Yes" = "yes", "No" = "no")) %>%
  ggplot() +
  geom_boxplot(aes(x = fct_relevel(milpa, "Yes", "No"), y = log(stemden_totaltrees)),
               fill = "mistyrose2", outlier.shape = 21,
               outlier.color = "gray20", outlier.fill = "gray80") +
  plot_theme +
  coord_cartesian(ylim = c(5, 8)) +
  labs(x = "Milpa exposure", y = "Total trees per hectare (log scale)")
ggsave("figures/stemden_fig3.png", height = 4, width = 6)
stemden_fig3

# Combined side-by-side box plots
stemden_fig_combined <- stemden_fig1 +
  (stemden_fig2 + labs(y = NULL) + theme(axis.title.y = element_blank())) +
  (stemden_fig3 + labs(y = NULL) + theme(axis.title.y = element_blank())) +
  plot_layout(ncol = 3)
ggsave("figures/stemden_fig_combined.png", stemden_fig_combined, height = 4, width = 8)
stemden_fig_combined
```


## Latitude and longitude by artisan

```{r}
data_plots %>%
  ggplot(aes(x = latitude, y = longitude)) +
    geom_point(aes(color = artisan), shape = 19) +
    xlim(-3, 2) +
    ylim(-3, 2) +
    theme_bw()
```



\newpage

# Models

We have fewer than five observations for each artisan, so we elect not to include artisan as a random effect. Also, some individuals appear in more than one level of artisan, so we could not disentangle variability due to each individual.

We decide to fit a negative binomial model with all other main effects, including latitude and longitude. We found that the variance of the residuals increases quadratically with the mean, so we believe a negative binomial model is more appropriate than a quasipoisson GLM.

We elect not to include the interaction between harvested and milpa or between harvested and vegetation type. Preliminary analyses found that these interactions were insignificant, and we have no ecological reason to believe that these interactions exist. Removing the interactions also enables us to interpret the main effects of harvested and milpa, which are our primary interests. Removing the interactions also enables a cleaner analysis of deviance table â€” we don't have to worry about a mismatch between the hypothesis tests run by `summary()` and by `Anova()`.



## Fit negative binomial model and check residual plots

```{r}
mod <- MASS::glm.nb(stemden_totaltrees_count ~ harvested + vegetation_type + milpa +
                      latitude + longitude + offset(log(plots_per_ha)), data = data_plots)
```

```{r}
par(mfrow = c(1,2))
plot(mod, which = 1:2)
```



## Summarize the model

```{r}
summary(mod)
```



## Construct analysis of deviance table

```{r}
# Use type 2 SS since data are unbalanced)
Anova(mod, type = 2, test.statistic = "LR")
```
