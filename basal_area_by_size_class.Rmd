---
title: "\\textbf{Basal area by size class}"
author: "\\textbf{Tim White}"
date: ""
output: pdf_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "pdfs") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      fig.height=4, fig.width=8, fig.align='center')
```



# Packages, data, and functions

```{r}
library(car)
library(tidyverse)

data_stems <- read_csv("data/data_stems.csv") %>%
                mutate(plot_id = as.factor(plot_id),
                       size_class = as.factor(size_class),
                       harvested = as.factor(harvested),
                       vegetation_type = as.factor(vegetation_type),
                       milpa = as.factor(milpa))
data_plots <- read_csv("data/data_plots.csv") %>%
                mutate(plot_id = as.factor(plot_id),
                       harvested = as.factor(harvested),
                       vegetation_type = as.factor(vegetation_type),
                       milpa = as.factor(milpa))

compute_bootstrap_interval <- function(var, statistic = mean, num_iters = 50000, 
                                       percentiles = c(0.025, 0.975)) {
  boot_samples <- numeric(num_iters)
  
  for (i in 1:num_iters) {
    boot_samples[i] <- statistic(sample(var, size = length(var), replace = TRUE))
  }
  
  return(quantile(boot_samples, percentiles))
}

plot_theme <- theme(plot.background = element_rect(fill = "white"),
                    plot.title = element_blank(), 
                    plot.subtitle = element_text(family="sans", face="plain"), 
                    axis.title.x = element_text(family="sans", face="bold"),
                    axis.title.y = element_text(family="sans", face="bold"),
                    axis.text.x = element_text(family="sans", face="plain"),
                    axis.text.y = element_text(family="sans", face="plain"),
                    panel.background = element_rect(fill="white"),
                    panel.grid.major.x = element_blank(),
                    panel.grid.major.y = element_line(color="gainsboro"),
                    panel.grid.minor = element_blank(),
                    axis.ticks = element_blank(),
                    legend.background = element_rect(color="black", fill = "white"),
                    legend.position = c(0.9, 0.85),
                    legend.title = element_text(color = "black", face = "bold", hjust = 0.5),
                    legend.text = element_text(color = "black"))
```



# Figures

## Average basal area by size class

### Compute boostrap intervals and organize data

```{r}
harvested <- data_plots %>%
              filter(harvested == "yes") %>%
              select(ba_saplings, starts_with("ba_trees"))
unharvested <- data_plots %>%
                filter(harvested == "no") %>%
                select(ba_saplings, starts_with("ba_trees"))

set.seed(2)
boot_intervals <- bind_rows(compute_bootstrap_interval(unharvested$ba_saplings),
                            compute_bootstrap_interval(unharvested$ba_trees05to09),
                            compute_bootstrap_interval(unharvested$ba_trees10to14),
                            compute_bootstrap_interval(unharvested$ba_trees15plus),
                            compute_bootstrap_interval(harvested$ba_saplings),
                            compute_bootstrap_interval(harvested$ba_trees05to09),
                            compute_bootstrap_interval(harvested$ba_trees10to14),
                            compute_bootstrap_interval(harvested$ba_trees15plus))

ba_mean_data <- data_plots %>%
                  select(harvested, ba_saplings, starts_with("ba_trees")) %>%
                  group_by(harvested) %>%
                  summarize_all(mean) %>%
                  pivot_longer(cols = starts_with("ba"), names_prefix = "ba_",
                               names_to = "size_class", values_to = "mean") %>%
                  bind_cols(boot_intervals) %>%
                  select(harvested, size_class, lower = `2.5%`, mean, upper = `97.5%`) %>%
                  mutate(size_class = as.factor(size_class)) %>%
                  mutate(harvested = fct_recode(harvested,
                                                "Harvested" = "yes", "Unharvested" = "no")) %>%
                  mutate(size_class = fct_recode(size_class,
                                                 "Saplings (0-4 cm DBH)" = "saplings",
                                                 "Trees (5-9 cm DBH)" = "trees05to09",
                                                 "Trees (10-14 cm DBH)" = "trees10to14",
                                                 "Trees (15+ cm DBH)" = "trees15plus"))
```

### Pointrange plot

```{r}
ba_sizeclass_fig1 <- ba_mean_data %>%
  ggplot() +
  geom_pointrange(aes(x = size_class, col = fct_relevel(harvested, "Harvested", "Unharvested"),
                      ymin = lower, y = mean, ymax = upper),
                  position = position_dodge(width = 0.5), size = 0.5, linewidth = 1) +
  plot_theme +
  theme(legend.position = c(0.1, 0.8)) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "Size class", y = "Average basal area (m2 per hectare)") +
  guides(col=guide_legend(title = "Status"))
ggsave("figures/not_in_manuscript/basal_area_sizeclass_pointrange.png", height = 4, width = 8)
ba_sizeclass_fig1
```

### Bar plot

```{r}
ba_sizeclass_fig2 <- ba_mean_data %>%
  ggplot(aes(x = size_class,
             fill = fct_relevel(harvested, "Harvested", "Unharvested"))) +
  geom_col(aes(y = mean),
           position = "dodge") +
  geom_errorbar(aes(x = size_class, ymin = lower, ymax = upper), col = "gray20",
                position = position_dodge(width = 0.9), width = 0.2, show.legend = FALSE) +
  plot_theme +
  theme(legend.position = c(0.1, 0.8)) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Size class", y = "Average basal area (m2 per hectare)") +
  guides(fill=guide_legend(title = "Status"))
ggsave("figures/basal_area_sizeclass.png", height = 4, width = 8)
ba_sizeclass_fig2
```

## Distribution of basal area by size class

### Organize data

```{r}
ba_dist_data <- data_plots %>%
                  select(harvested, ba_saplings, starts_with("ba_trees")) %>%
                  pivot_longer(cols = starts_with("ba"),
                               names_prefix = "ba_",
                               names_to = "size_class",
                               values_to = "ba") %>%
                  mutate(size_class = as.factor(size_class)) %>%
                  mutate(harvested = fct_recode(harvested,
                                                "Harvested" = "yes",
                                                "Unharvested" = "no")) %>%
                  mutate(size_class = fct_recode(size_class,
                                                 "Saplings (0-4 cm DBH)" = "saplings",
                                                 "Trees (5-9 cm DBH)" = "trees05to09",
                                                 "Trees (10-14 cm DBH)" = "trees10to14",
                                                 "Trees (15+ cm DBH)" = "trees15plus"))
```

### Violin plot

```{r}
ba_dist_data %>%
  ggplot() +
  geom_violin(aes(x = size_class, y = ba,
                  fill = fct_relevel(harvested, "Harvested", "Unharvested")),
              scale = "area", width = 2, position = position_dodge(width = 0.7),
              lwd = 0.75, kernel = "gaussian", adjust = 1.25) +
  plot_theme +
  theme(legend.position = c(0.1, 0.8)) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Size class", y = "Basal area (m2 per hectare)") +
  guides(fill = guide_legend(title = "Status"))
```

### Box plot

```{r}
ba_sizeclass_fig3 <- ba_dist_data %>%
  ggplot() +
  geom_boxplot(aes(x = size_class, y = ba,
                   fill = fct_relevel(harvested, "Harvested", "Unharvested")),
               outlier.shape = 21, outlier.color = "gray20",
               outlier.fill = "gray80") +
  plot_theme +
  theme(legend.position = c(0.1, 0.8)) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Size class", y = "Basal area (m2 per hectare)") +
  guides(fill = guide_legend(title = "Status"))
ggsave("figures/not_in_manuscript/basal_area_sizeclass_boxplot.png", height = 4, width = 8)
ba_sizeclass_fig3
```

## Basal area by size class for different covariates

### Histograms, harvesting status

```{r}
data_plots %>%
  ggplot() + geom_histogram(aes(x = ba_saplings), bins = 20,
                            col = "black", fill = "gray80") + plot_theme
data_plots %>%
  ggplot() + geom_histogram(aes(x = ba_trees05to09), bins = 20,
                            col = "black", fill = "gray80") + plot_theme
data_plots %>%
  ggplot() + geom_histogram(aes(x = ba_trees10to14), bins = 20,
                            col = "black", fill = "gray80") + plot_theme
data_plots %>%
  ggplot() + geom_histogram(aes(x = ba_trees15plus), bins = 10,
                            col = "black", fill = "gray80") + plot_theme
```

### Five-number summaries, harvesting status

```{r}
summary(data_plots$ba_saplings)
data_plots %>% filter(harvested == "yes") %>% pull(ba_saplings) %>% summary()
data_plots %>% filter(harvested == "no") %>% pull(ba_saplings) %>% summary()

summary(data_plots$ba_trees05to09)
data_plots %>% filter(harvested == "yes") %>% pull(ba_trees05to09) %>% summary()
data_plots %>% filter(harvested == "no") %>% pull(ba_trees05to09) %>% summary()

summary(data_plots$ba_trees10to14)
data_plots %>% filter(harvested == "yes") %>% pull(ba_trees10to14) %>% summary()
data_plots %>% filter(harvested == "no") %>% pull(ba_trees10to14) %>% summary()

summary(data_plots$ba_trees15plus)
data_plots %>% filter(harvested == "yes") %>% pull(ba_trees15plus) %>% summary()
data_plots %>% filter(harvested == "no") %>% pull(ba_trees15plus) %>% summary()
```

### Box plots, harvesting status

```{r}
data_plots %>% ggplot() +
  geom_boxplot(aes(x = harvested, y = ba_saplings),
               col = "black", fill = "gray80") + plot_theme
data_plots %>% ggplot() +
  geom_boxplot(aes(x = harvested, y = ba_trees05to09),
               col = "black", fill = "gray80") + plot_theme
data_plots %>% ggplot() +
  geom_boxplot(aes(x = harvested, y = ba_trees10to14),
               col = "black", fill = "gray80") + plot_theme
data_plots %>% ggplot() +
  geom_boxplot(aes(x = harvested, y = ba_trees15plus),
               col = "black", fill = "gray80") + plot_theme
```

### Box plots, vegetation type

```{r}
data_plots %>% ggplot() +
  geom_boxplot(aes(x = vegetation_type, y = ba_saplings),
               col = "black", fill = "gray80") + plot_theme
data_plots %>% ggplot() +
  geom_boxplot(aes(x = vegetation_type, y = ba_trees05to09),
               col = "black", fill = "gray80") + plot_theme
data_plots %>% ggplot() +
  geom_boxplot(aes(x = vegetation_type, y = ba_trees10to14),
               col = "black", fill = "gray80") + plot_theme
data_plots %>% ggplot() +
  geom_boxplot(aes(x = vegetation_type, y = ba_trees15plus),
               col = "black", fill = "gray80") + plot_theme
```

### Box plots, milpa exposure

```{r}
data_plots %>% ggplot() +
  geom_boxplot(aes(x = milpa, y = ba_saplings),
               col = "black", fill = "gray80") + plot_theme
data_plots %>% ggplot() +
  geom_boxplot(aes(x = milpa, y = ba_trees05to09),
               col = "black", fill = "gray80") + plot_theme
data_plots %>% ggplot() +
  geom_boxplot(aes(x = milpa, y = ba_trees10to14),
               col = "black", fill = "gray80") + plot_theme
data_plots %>% ggplot() +
  geom_boxplot(aes(x = milpa, y = ba_trees15plus),
               col = "black", fill = "gray80") + plot_theme
```



# Models

## Seedlings

Seedlings have zero basal area by definition, so there is no need to fit a model for seedlings.

## Saplings (0-4 cm DBH)

### Fit gamma model and check residual plots

```{r}
mod_saplings <- glm(ba_saplings ~ harvested + vegetation_type + milpa + latitude + longitude,
                    family = Gamma(link="log"), data = data_plots)
```

```{r}
par(mfrow = c(1,2))
plot(mod_saplings, which = 1:2)
```

### Summarize the model

```{r}
summary(mod_saplings)
```

### Construct analysis of deviance table

```{r}
Anova(mod_saplings, type = 2, test.statistic = "LR")
```

## Trees (5-9 cm DBH)

### Fit gamma model and check residual plots

```{r}
mod_trees05to09 <- glm(ba_trees05to09 ~ harvested + vegetation_type + milpa + latitude + longitude,
                       family = Gamma(link="log"), data = data_plots)
```

```{r}
par(mfrow = c(1,2))
plot(mod_trees05to09, which = 1:2)
```

### Summarize the model

```{r}
summary(mod_trees05to09)
```

### Construct analysis of deviance table

```{r}
Anova(mod_trees05to09, type = 2, test.statistic = "LR")
```

## Trees (10-14 cm DBH)

### Fit gamma model and check residual plots

```{r}
mod_trees10to14 <- glm(ba_trees10to14 ~ harvested + vegetation_type + milpa + latitude + longitude,
                       family = Gamma(link="log"), data = data_plots)
```

```{r}
par(mfrow = c(1,2))
plot(mod_trees10to14, which = 1:2)
```

### Summarize the model

```{r}
summary(mod_trees10to14)
```

### Construct analysis of deviance table

```{r}
Anova(mod_trees10to14, type = 2, test.statistic = "LR")
```

## Trees (15+ cm DBH)

### Fit gamma model and check residual plots

There are four plots with zero 15+ cm trees. We decide to drop these four plots; otherwise, we cannot use the gamma GLM.

```{r}
mod_trees15plus <- glm(ba_trees15plus ~ harvested + vegetation_type + milpa + latitude + longitude,
                       family = Gamma(link="log"), data = data_plots %>% filter(stemden_trees15plus_count > 0))
```

```{r}
par(mfrow = c(1,2))
plot(mod_trees15plus, which = 1:2)
```

### Summarize the model

```{r}
summary(mod_trees15plus)
```

### Construct analysis of deviance table

```{r}
Anova(mod_trees15plus, type = 2, test.statistic = "LR")
```

