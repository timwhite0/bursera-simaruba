---
title: "\\textbf{Final models}"
author: "\\textbf{Tim White}"
date: ""
output: pdf_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "pdfs") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      fig.height=3, fig.width=5, fig.align='center')
options(knitr.kable.NA = "")
```



# Packages, data, and functions

```{r}
library(car)
library(tidyverse)
library(knitr)

data_stems <- read_csv("data/data_stems.csv") %>%
                mutate(plot_id = as.factor(plot_id),
                       size_class = as.factor(size_class),
                       harvested = as.factor(harvested),
                       vegetation_type = as.factor(vegetation_type),
                       milpa = as.factor(milpa))
data_plots <- read_csv("data/data_plots.csv") %>%
                mutate(plot_id = as.factor(plot_id),
                       harvested = as.factor(harvested),
                       vegetation_type = as.factor(vegetation_type),
                       milpa = as.factor(milpa))

summarize_glm <- function(mod) {
  summary <- summary(mod)
  table <- tibble(var = c("intercept", "harvestedYes", "vegetationKeelenche",
                          "vegetationNukuuchche", "milpaYes", "latitude", "longitude"),
                  coef = summary$coefficients[,1], se = summary$coefficients[,2]) %>%
              mutate_if(is.numeric, function(col) {round(col, 3)}) %>%
              kable(col.names = c("", "Coefficient", "SE"), align = "c")
  return(table)
}

analysis_of_deviance <- function(mod, p_adj) {
  summary <- Anova(mod, type = 2, test.statistic = "LR")
  table <- tibble(var = c("harvested", "vegetation", "milpa", "latitude", "longitude"),
                  chisq = summary$`LR Chisq`, df = summary$Df, p = summary$`Pr(>Chisq)`, p_adj) %>%
              mutate_if(is.numeric, function(col) {round(col, 3)}) %>%
              kable(col.names = c("", "Chisq", "df", "p-value", "adjusted p-value"), align = "c")
  return(table)
}
```



\newpage

# Fit models and adjust p-values for analysis of deviance tables

```{r}
stemden_mod <- MASS::glm.nb(stemden_totaltrees_count ~ harvested + vegetation_type +
                milpa + latitude + longitude + offset(log(plots_per_ha)), data = data_plots)

stemden_mod_seedlings <- MASS::glm.nb(stemden_seedlings_count ~ harvested + vegetation_type +
                milpa + latitude + longitude + offset(log(plots_per_ha)), data = data_plots)

stemden_mod_saplings <- MASS::glm.nb(stemden_saplings_count ~ harvested + vegetation_type +
                milpa + latitude + longitude + offset(log(plots_per_ha)), data = data_plots)

stemden_mod_trees05to09 <- MASS::glm.nb(stemden_trees05to09_count ~ harvested + vegetation_type +
                milpa + latitude + longitude + offset(log(plots_per_ha)), data = data_plots)

stemden_mod_trees10to14 <- MASS::glm.nb(stemden_trees10to14_count ~ harvested + vegetation_type +
                milpa + latitude + longitude + offset(log(plots_per_ha)), data = data_plots)

stemden_mod_trees15plus <- MASS::glm.nb(stemden_trees15plus_count ~ harvested + vegetation_type +
                milpa + latitude + longitude + offset(log(plots_per_ha)), data = data_plots)

ba_mod <- glm(ba_totaltrees ~ harvested + vegetation_type + milpa + latitude + longitude,
              family = Gamma(link="log"), data = data_plots)

ba_mod_saplings <- glm(ba_saplings ~ harvested + vegetation_type + milpa +
                    latitude + longitude, family = Gamma(link="log"), data = data_plots)

ba_mod_trees05to09 <- glm(ba_trees05to09 ~ harvested + vegetation_type + milpa +
                    latitude + longitude, family = Gamma(link="log"), data = data_plots)

ba_mod_trees10to14 <- glm(ba_trees10to14 ~ harvested + vegetation_type + milpa +
                    latitude + longitude, family = Gamma(link="log"), data = data_plots)

ba_mod_trees15plus <- glm(ba_trees15plus ~ harvested + vegetation_type + milpa +
                          latitude + longitude, family = Gamma(link="log"),
                          data = data_plots %>% filter(stemden_trees15plus_count > 0))
```

```{r}
p_values <- c(Anova(stemden_mod, type = 2, test.statistic = "LR")[,3],
              Anova(stemden_mod_seedlings, type = 2, test.statistic = "LR")[,3],
              Anova(stemden_mod_saplings, type = 2, test.statistic = "LR")[,3],
              Anova(stemden_mod_trees05to09, type = 2, test.statistic = "LR")[,3],
              Anova(stemden_mod_trees10to14, type = 2, test.statistic = "LR")[,3],
              Anova(stemden_mod_trees15plus, type = 2, test.statistic = "LR")[,3],
              Anova(ba_mod, type = 2, test.statistic = "LR")[,3],
              Anova(ba_mod_saplings, type = 2, test.statistic = "LR")[,3],
              Anova(ba_mod_trees05to09, type = 2, test.statistic = "LR")[,3],
              Anova(ba_mod_trees10to14, type = 2, test.statistic = "LR")[,3],
              Anova(ba_mod_trees15plus, type = 2, test.statistic = "LR")[,3])

# Apply Benjamini-Hochberg procedure
adjusted_p_values <- p.adjust(p_values, method = "BH")
```



# Stem density

### Model

$$
\begin{aligned}
\log E[Y|X] \sim \thinspace &\beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 + \beta_6 X_6 + \log\text{(plots per ha)}
\end{aligned}
$$
where $Y$ is the total number of stems per plot and $X = \{X_1,X_2,X_3,X_4,X_5,X_6\}$, where $X_1$ is a binary variable indicating whether a plot has been harvested, $X_2$ and $X_3$ are indicator variables for the Keelenche and Nukuuchche vegetation types, $X_4$ is a binary variable indicating whether a plot has been exposed to milpa, $X_5$ is latitude, and $X_6$ is longitude. We set $\text{Var}(Y|X) = E[Y|X] (1 + \theta E[Y|X])$, where $\theta$ is the negative binomial dispersion parameter.

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(stemden_mod, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Model summary

```{r echo = FALSE}
summarize_glm(stemden_mod)
```


### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(stemden_mod, adjusted_p_values[1:5])
```



\newpage

# Stem density by size class

For each size class, the model is the same as the one written above except $Y$ denotes the number of individuals (per plot) in each size class.

## Seedlings

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(stemden_mod_seedlings, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Model summary

```{r echo = FALSE}
summarize_glm(stemden_mod_seedlings)
```

### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(stemden_mod_seedlings, adjusted_p_values[6:10])
```



\newpage

## Saplings (0-4 cm DBH)

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(stemden_mod_saplings, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Model summary

```{r echo = FALSE}
summarize_glm(stemden_mod_saplings)
```

### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(stemden_mod_saplings, adjusted_p_values[11:15])
```



\newpage

## Trees (5-9 cm DBH)

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(stemden_mod_trees05to09, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Model summary

```{r echo = FALSE}
summarize_glm(stemden_mod_trees05to09)
```

### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(stemden_mod_trees05to09, adjusted_p_values[16:20])
```

\newpage

## Trees (10-14 cm DBH)

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(stemden_mod_trees10to14, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Model summary

```{r echo = FALSE}
summarize_glm(stemden_mod_trees10to14)
```

### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(stemden_mod_trees10to14, adjusted_p_values[21:25])
```



\newpage

## Trees (15+ cm DBH)

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(stemden_mod_trees15plus, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Model summary

```{r echo = FALSE}
summarize_glm(stemden_mod_trees15plus)
```

### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(stemden_mod_trees15plus, adjusted_p_values[26:30])
```



\newpage

# Basal area

### Model

$$
\begin{aligned}
\log E[Y|X] \sim \thinspace &\beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 + \beta_6 X_6
\end{aligned}
$$
where $Y$ is the total basal area per hectare and $X = \{X_1,X_2,X_3,X_4,X_5,X_6\}$, where $X_1$ is a binary variable indicating whether a plot has been harvested, $X_2$ and $X_3$ are indicator variables for the Keelenche and Nukuuchche vegetation types, $X_4$ is a binary variable indicating whether a plot has been exposed to milpa, $X_5$ is latitude, and $X_6$ is longitude. We set $\text{Var}(Y|X) = \phi E[Y|X]^2$, where $\phi$ is the gamma dispersion parameter.

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(ba_mod, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Model summary

```{r echo = FALSE}
summarize_glm(ba_mod)
```

### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(ba_mod, adjusted_p_values[31:35])
```



\newpage

# Basal area by size class

For each size class, the model is the same as the one written above except $Y$ denotes the total basal area per hectare in each size class.

## Saplings (0-4 cm DBH)

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(ba_mod_saplings, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Summarize model

```{r echo = FALSE}
summarize_glm(ba_mod_saplings)
```

### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(ba_mod_saplings, adjusted_p_values[36:40])
```



\newpage

## Trees (5-9 cm DBH)

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(ba_mod_trees05to09, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Summarize model

```{r echo = FALSE}
summarize_glm(ba_mod_trees05to09)
```

### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(ba_mod_trees05to09, adjusted_p_values[41:45])
```



\newpage

## Trees (10-14 cm DBH)

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(ba_mod_trees10to14, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Summarize model

```{r echo = FALSE}
summarize_glm(ba_mod_trees10to14)
```

### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(ba_mod_trees10to14, adjusted_p_values[46:50])
```



\newpage

## Trees (15+ cm DBH)

### Diagnostic plots

```{r echo = FALSE}
par(mfrow = c(1,2))
plot(ba_mod_trees15plus, which = 1:2, pch = 19, cex.axis = 0.75, cex.lab = 0.75, cex.caption = 0.75)
```

### Summarize model

```{r echo = FALSE}
summarize_glm(ba_mod_trees15plus)
```

### Analysis of deviance table

```{r echo = FALSE}
analysis_of_deviance(ba_mod_trees15plus, adjusted_p_values[51:55])
```


