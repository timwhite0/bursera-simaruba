---
title: "\\textbf{Basal area}"
author: "\\textbf{Tim White}"
date: ""
output: pdf_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "pdfs") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      fig.height=3, fig.width=5, fig.align='center')
```



# Packages and data

```{r}
library(car)
library(tidyverse)
library(patchwork)

data_stems <- read_csv("data/data_stems.csv") %>%
                mutate(plot_id = as.factor(plot_id),
                       size_class = as.factor(size_class),
                       harvested = as.factor(harvested),
                       vegetation_type = as.factor(vegetation_type),
                       milpa = as.factor(milpa))
data_plots <- read_csv("data/data_plots.csv") %>%
                mutate(plot_id = as.factor(plot_id),
                       harvested = as.factor(harvested),
                       vegetation_type = as.factor(vegetation_type),
                       milpa = as.factor(milpa))

plot_theme <- theme(plot.background = element_rect(fill = "white"),
                    plot.title = element_blank(), 
                    plot.subtitle = element_text(family="sans", face="plain"), 
                    axis.title.x = element_text(family="sans", face="bold"),
                    axis.title.y = element_text(family="sans", face="bold"),
                    axis.text.x = element_text(family="sans", face="plain"),
                    axis.text.y = element_text(family="sans", face="plain"),
                    panel.background = element_rect(fill="white"),
                    panel.grid.major.x = element_blank(),
                    panel.grid.major.y = element_line(color="gainsboro"),
                    panel.grid.minor = element_blank(),
                    axis.ticks = element_blank(),
                    legend.background = element_rect(color="black", fill = "white"),
                    legend.position = c(0.9, 0.85),
                    legend.title = element_text(color = "black", face = "bold", hjust = 0.5),
                    legend.text = element_text(color = "black"))
```



# Figures

## Histograms of total basal area of trees

```{r}
# All plots
data_plots %>%
  ggplot() +
    geom_histogram(aes(x = ba_totaltrees), bins = 10, fill = "gray90", col = "black") +
    theme_classic() + ylim(c(0,20))

# Harvested vs. unharvested plots
data_plots %>%
  ggplot() +
  geom_histogram(aes(x = ba_totaltrees), bins = 5, fill = "gray90", col = "black") +
  facet_wrap(~harvested) +
  theme_classic() + ylim(c(0,20))
```

## Five-number summaries of total basal area of trees

```{r}
# All plots
summary(data_plots$ba_totaltrees)

# Harvested vs. unharvested plots
data_plots %>% filter(harvested == "yes") %>% pull(ba_totaltrees) %>% summary()
data_plots %>% filter(harvested == "no") %>% pull(ba_totaltrees) %>% summary()
```

## Box plots of total basal area of trees

```{r}
# By harvesting status
ba_fig1 <- data_plots %>%
  mutate(harvested = fct_recode(harvested,
                                "Harvested" = "yes", "Unharvested" = "no")) %>%
  ggplot() +
    geom_boxplot(aes(x = fct_relevel(harvested, "Harvested", "Unharvested"),
                     y = ba_totaltrees),
                 fill = "mistyrose2", outlier.shape = 21,
                 outlier.color = "gray20", outlier.fill = "gray80") +
    plot_theme +
    coord_cartesian(ylim = c(0, 15)) +
    labs(x = "Plot status", y = "Total basal area of trees (m2 per hectare)")
ggsave("figures/not_in_manuscript/basal_area_harvest_boxplot.png", height = 4, width = 6)
ba_fig1

# By vegetation type
ba_fig2 <- data_plots %>%
  mutate(vegetation_type = fct_recode(vegetation_type,
                                      "Ju'uche'" = "juuche",
                                      "Keelenche'" = "keelenche",
                                      "Nuku'uch che'" = "nukuuchche")) %>%
  ggplot() +
  geom_boxplot(aes(x = vegetation_type, y = ba_totaltrees),
               fill = "mistyrose2", outlier.shape = 21,
               outlier.color = "gray20", outlier.fill = "gray80") +
  plot_theme +
  coord_cartesian(ylim = c(0, 15)) +
  labs(x = "Vegetation type", y = "Total basal area of trees (m2 per hectare)")
ggsave("figures/not_in_manuscript/basal_area_vegetation_boxplot.png", height = 4, width = 6)
ba_fig2

# By milpa
ba_fig3 <- data_plots %>%
  mutate(milpa = fct_recode(milpa,
                            "Yes" = "yes", "No" = "no")) %>%
  ggplot() +
  geom_boxplot(aes(x = fct_relevel(milpa, "Yes", "No"), y = ba_totaltrees),
               fill = "mistyrose2", outlier.shape = 21,
               outlier.color = "gray20", outlier.fill = "gray80") +
  plot_theme +
  coord_cartesian(ylim = c(0, 15)) +
  labs(x = "Milpa exposure", y = "Total basal area of trees (m2 per hectare)")
ggsave("figures/not_in_manuscript/basal_area_milpa_boxplot.png", height = 4, width = 6)
ba_fig3

# Combined side-by-side box plots
ba_fig_combined <- ba_fig1 +
  (ba_fig2 + labs(y = NULL) + theme(axis.title.y = element_blank())) +
  (ba_fig3 + labs(y = NULL) + theme(axis.title.y = element_blank())) +
  plot_layout(ncol = 3)
ggsave("figures/basal_area_boxplots.png", ba_fig_combined, height = 4, width = 8)
ba_fig_combined
```



\newpage

# Models

We found that the residuals of a standard linear model had heteroscedastic variance. We considered a Gaussian GLM and a gamma GLM, both with log link. The residuals of the former also had heteroscedastic variance, so we decide to proceed with the latter.

## Fit gamma model and check residual plots

```{r}
mod <- glm(ba_totaltrees ~ harvested + vegetation_type + milpa + latitude + longitude,
           family = Gamma(link="log"), data = data_plots)
```

```{r}
par(mfrow = c(1,2))
plot(mod, which = 1:2)
```

## Summarize the model

```{r}
summary(mod)
```

## Construct analysis of deviance table

```{r}
Anova(mod, type = 2, test.statistic = "LR")
```
